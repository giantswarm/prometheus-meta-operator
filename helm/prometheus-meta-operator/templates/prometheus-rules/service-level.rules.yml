apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  creationTimestamp: null
  labels:
    {{- include "labels.common" . | nindent 4 }}
  name: service-level.rules
spec:
  groups:
  - name: service-level
    rules:
    - alert: ServiceLevelBurnRateTooHigh
      annotations:
        description: '{{`Service level burn rate is too high for {{ $labels.service }} service.`}}'
        opsrecipe: service-level-burn-rate-too-high/
      expr: |
        slo_errors_per_request:ratio_rate1h{service=~"api-server|kubelet"}
        and on (service)
        (
        slo_errors_per_request:ratio_rate1h > on (service) group_left (cluster_type, cluster_id, class) slo_threshold_high
        and
        slo_errors_per_request:ratio_rate5m > on (service) group_left (cluster_type, cluster_id, class) slo_threshold_high
        or
        slo_errors_per_request:ratio_rate6h > on (service) group_left (cluster_type, cluster_id, class) slo_threshold_low
        and
        slo_errors_per_request:ratio_rate30m > on (service) group_left (cluster_type, cluster_id, class) slo_threshold_low
        )
      for: 5m
      labels:
        cancel_if_cluster_status_creating: "true"
        cancel_if_cluster_status_deleting: "true"
        cancel_if_cluster_status_updating: "true"
        severity: page
    - alert: ServiceLevelBurnRateTicket
      annotations:
        description: '{{`There is a constant low burn rate for {{ $labels.service }} service. Please create a PM.`}}'
        opsrecipe: service-level-burn-rate-too-high/
      expr: |
        slo_errors_per_request:ratio_rate24h > on (service) group_left (cluster_type, cluster_id, class) 3 * slo_target
        and
        slo_errors_per_request:ratio_rate2h > on (service) group_left (cluster_type, cluster_id, class) 3 * slo_target
        or
        slo_errors_per_request:ratio_rate3d > on (service) group_left (cluster_type, cluster_id, class) slo_target
        and
        slo_errors_per_request:ratio_rate6h > on (service) group_left (cluster_type, cluster_id, class) slo_target
      for: 5m
      labels:
        cancel_if_outside_working_hours: "true"
        cancel_if_cluster_status_creating: "true"
        cancel_if_cluster_status_deleting: "true"
        cancel_if_cluster_status_updating: "true"
        severity: page
